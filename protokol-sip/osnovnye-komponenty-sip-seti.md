# Основные компоненты SIP сети

Стандарт SIP описан в RFC [3261](https://www.rfc-editor.org/info/rfc3261). А в дальнейшем расширен другими RFC.

Итак протокол SIP представляет собой клиент серверный текстовый протокол.

То есть, у нас есть клиент который посылает запрос в текстовом виде и есть сервер который обрабатывает этот запрос и отвечает на него.

## User Agent \(Абонентский терминал\)

Итак у нас есть конечное устройство использующее протокол SIP \( у Гольдштейна это абонентский терминал\) например sip телефон. В RFC это User Agent \(UA\) Программное обеспечение UA Соответственно состоит из 2 частей: User Agent Сlient \(UAC \) клиентом агента пользователя и User Agent Server \(UAS\) - сервером агента пользователя. Во время sip сессии

Ниже представлен простой пример взаимодействия между двумя sip телефонами \(UA\)

![&#x412;&#x437;&#x430;&#x438;&#x43C;&#x43E;&#x434;&#x435;&#x439;&#x441;&#x442;&#x432;&#x438;&#x435; &#x43F;&#x43E; &#x43F;&#x440;&#x43E;&#x442;&#x43E;&#x43A;&#x43E;&#x43B;&#x443; SIP &#x43C;&#x435;&#x436;&#x434;&#x443; 2-&#x43C;&#x44F; &#x442;&#x435;&#x43B;&#x435;&#x444;&#x43E;&#x43D;&#x430;&#x43C;&#x438;](../.gitbook/assets/sip-ua-to-ua.png)

UA \(абонентский терминал\) должен как минимум выполнять следующие функции:

* Должен сохранять состояние звонков которые он инициализировал или в которых он участвует. Даже если звонок был прерван UA должен сохранять состояние звонка в течении 32 сек в случае потери сообщений во время завершения SIP сессии.
* Запросы к неизвестному URI получают ответ _404  Not Found_ 
* UA игнорирует любой ACK полученный для неизвестного диалога
* Если UA  получает запрос для неизвестного ему диалога то он отправляет в ответ сообщение _481 Dialog/Transaction Does Not Exist_  
* Любые ответы для неизвестного диалога игнорируются.
* UA должен обрабатывать неизвестные ему ответы основываясь на классе ответа первой цифре в ответе. Например ответ с кодом 499 будет обработан как 400 
* На любой неизвестный запрос UA отвечает сообщением _501 Not Implemented_
* Для обработки сообщений больше 1300 байт UA **обязан** поддерживать TCP. 
* UA обязан поддерживать протокол SDP
* Для установления сессии UA обязан поддерживать все расширения описанные в заголовке _Require_ запроса.
* Заголовки неподерживаемые UA игнорируются.
* UA Сообщает о своих возможностях в каждом запросе. Так методы поддерживаемые UA перечисляются в заголовке _Supported._ 

## Proxy Server

Прокси сервер это промежуточный элемент SIP сети который получает SIP запросы от UA или других прокси серверов и пересылает их дальше. обычно выступает в роли маршрутизатора в сети SIP. Обычно прокси сервер взаимодействует с сервером местоположения для определения получателя sip сообщения.

* Сам прокси сервер не инициирует запрос, а только отвечает на запросы UA. За исключением запросов _ACK_ и _CANCEL_.
* Прокси сервер не обрабатывает тело SIP сообщения, а работает только с заголовками
* Прокси сервер не работает с медиа.

SIP прокси может быть двух типов:

#### Прокси сервер без сохранения состояния

Stateless прокси сервер обрабатывает каждый запрос или ответ исключительно на основе содержимого SIP сообщения. После обработки и отправки сип сообщения информация о нем не сохраняется. Stateless прокси сервер не использует таймеры и не осуществляет повторную отправку SIP сообщения. Если stateless прокси получает повторное сообщение то он обрабатывает его так, как и первое.

Ключевые особенности stateless sip прокси:

* Stateless прокси не посылает предварительные \(1xx\) ответы.
* Не выполняет повторную отправку запросов
* Игнорирует _ACK_
* Игнорирует _CANCEL_
* Параметр branch поля TO высчитывается на основе параметров сообщения.

#### Прокси сервер с сохранением состояния \(Statefull\)

    

Прокси сервер с сохранением состояния \(statefull\) сохраняет информацию о полученных и отправленных запросах и ответах на них. И использует эту информацию при обработке последующих запросах и ответах. 

* Statefull прокси сервер использует таймеры и выполняет повторную пересылку запросов. 
* Посылает предварительные ответы \(1xx\)
* Statefull прокси, после определения местоположения назначения запроса, может осуществлять параллельную отправку запроса нескольким адресатам \(ветвление\)

## Сервер переадресаций \(Redirect Server\)

Сервер переадреаций - это сервер который определяет местоположение пользователя и отвечает на запрос сообщением 3XX. Поле контакт данного ответа содержит новый адрес назначения.

## Back-to-Back User Agents

B2BUA это сервер в sip сети который пучает запросы обрабатывает их и формирует новый запрос который пересылает адресату. При этом весь запрос формируется заново. и со стороны B2BUA будет существовать две sip сессии. 



Сервер B2BUA может предоставлять следующие функции:

* Управление звонками \(биллинг, перевод звонка, автоматическое разъединение и т. д.\)
* Сопряжение разных сетей \(в частности, для адаптации разных диалектов протокола, зависимых от производителей\)
* Сокрытие структуры сети \(частные адреса, сетевая топология \)

## Пограничный контролер сессий. SBC 

Пограничный контролер сессий это специальный элемент SIP сети, который ставится на границе операторской сети и служит точкой для входа в сеть. Работает как B2BUA и выполняет следующие функции:

 

* Сокрытие топологии сети 
* Нормализация и трансляция сигнальных протоколов
* Нормализация и трансляция медиа-протоколов 
* Обеспечение единой точки съема трафика \(например для зеркалирования \)
* Единая точка сбора биллинговой информации
* Управление нагрузкой \(защита от атак, сглаживание всплесков трафика, защита внутренней сети от перегрузки\)
* Контроль доступа 
* Обеспечение прохождения NAT
* Обеспечение доступности внезвонковых сервисов для авторизованных абонентов \(регистрация оконечных устройств, информирование о статусах\)
*  Мониторинг качества



